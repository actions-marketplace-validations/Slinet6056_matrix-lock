name: Test Matrix Lock

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    test-lock:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - id: test-1
                      name: "Test Job 1"
                      duration: 5
                    - id: test-2
                      name: "Test Job 2"
                      duration: 3
                    - id: test-3
                      name: "Test Job 3"
                      duration: 4

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Initialize matrix lock
              if: matrix.id == 'test-1'
              uses: ./
              with:
                  step: init
                  order: "test-1,test-2,test-3"

            - name: Wait for lock
              uses: ./
              with:
                  step: wait
                  id: ${{ matrix.id }}
                  retry-count: 12
                  retry-delay: 10

            - name: Run test job
              run: |
                  echo "Running ${{ matrix.name }}"
                  echo "Simulating work for ${{ matrix.duration }} seconds..."
                  sleep ${{ matrix.duration }}
                  echo "Completed ${{ matrix.name }}"

            - name: Release lock
              if: always()
              uses: ./
              with:
                  step: continue
